<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:viewmodels="clr-namespace:Player.ViewModels"
  xmlns:models="clr-namespace:JellyfinPlayer.Lib.Api.Models;assembly=Lib.JellyfinApi"
  x:Class="Player.Pages.LibraryManagementPage"
  x:DataType="viewmodels:LibraryManagementViewModel"
  Title="Library Management"
>
  <ContentPage.ToolbarItems>
    <ToolbarItem
      Text="Scan All"
      Command="{Binding ScanLibraryCommand}"
      IsEnabled="{Binding IsAdmin}"
    />
  </ContentPage.ToolbarItems>

  <RefreshView IsRefreshing="{Binding IsLoading}" Command="{Binding LoadDataCommand}">
    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!-- Main Content -->
      <ScrollView Grid.Row="0">
        <VerticalStackLayout Padding="20" Spacing="20">
          <!-- Admin Check Message -->
          <VerticalStackLayout
            Spacing="10"
            IsVisible="{Binding IsAdmin, Converter={StaticResource InvertedBoolConverter}}"
          >
            <Label
              Text="Access Denied"
              FontSize="22"
              FontAttributes="Bold"
              HorizontalOptions="Center"
            />
            <Label
              Text="{Binding ErrorMessage}"
              TextColor="{DynamicResource ErrorColor}"
              FontSize="16"
              HorizontalOptions="Center"
              HorizontalTextAlignment="Center"
            />
          </VerticalStackLayout>

          <!-- Libraries List -->
          <VerticalStackLayout Spacing="16" IsVisible="{Binding IsAdmin}">
            <Label
              Text="Libraries"
              Style="{StaticResource SubHeadline}"
              FontSize="22"
              FontAttributes="Bold"
            />

            <!-- Success Message -->
            <Label
              Text="{Binding SuccessMessage}"
              TextColor="{DynamicResource SecondaryColor}"
              IsVisible="{Binding SuccessMessage, Converter={StaticResource IsStringNotNullOrEmptyConverter}}"
              FontSize="14"
            />

            <!-- Error Message -->
            <Label
              Text="{Binding ErrorMessage}"
              TextColor="{DynamicResource ErrorColor}"
              IsVisible="{Binding ErrorMessage, Converter={StaticResource IsStringNotNullOrEmptyConverter}}"
              FontSize="14"
            />

            <!-- Library Cards -->
            <CollectionView ItemsSource="{Binding Libraries}">
              <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="{x:Type models:VirtualFolderInfo}">
                  <Frame
                    Padding="16"
                    Margin="0,0,0,12"
                    BackgroundColor="{DynamicResource CardBackgroundColor}"
                    BorderColor="{DynamicResource CardBorderColor}"
                    CornerRadius="8"
                    HasShadow="False"
                  >
                    <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                      <!-- Library Name -->
                      <Label
                        Grid.Row="0"
                        Grid.Column="0"
                        Text="{Binding Name}"
                        FontSize="18"
                        FontAttributes="Bold"
                        TextColor="{DynamicResource TextColor}"
                        Margin="0,0,0,8"
                      />

                      <!-- Collection Type -->
                      <Label
                        Grid.Row="1"
                        Grid.Column="0"
                        Grid.ColumnSpan="2"
                        Text="{Binding CollectionType, StringFormat='Type: {0}'}"
                        FontSize="14"
                        TextColor="{DynamicResource MutedTextColor}"
                        Margin="0,0,0,8"
                      />

                      <!-- Paths -->
                      <VerticalStackLayout
                        Grid.Row="2"
                        Grid.Column="0"
                        Grid.ColumnSpan="2"
                        Spacing="4"
                      >
                        <Label
                          Text="Paths:"
                          FontSize="14"
                          FontAttributes="Bold"
                          TextColor="{DynamicResource TextColor}"
                          Margin="0,0,0,4"
                        />
                        <CollectionView ItemsSource="{Binding Locations}">
                          <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="{x:Type x:String}">
                              <Label
                                Text="{Binding}"
                                FontSize="13"
                                TextColor="{DynamicResource MutedTextColor}"
                                Margin="8,0,0,2"
                              />
                            </DataTemplate>
                          </CollectionView.ItemTemplate>
                        </CollectionView>
                      </VerticalStackLayout>

                      <!-- Delete Button -->
                      <Button
                        Grid.Row="0"
                        Grid.Column="1"
                        Text="Delete"
                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryManagementViewModel}}, Path=DeleteLibraryCommand, x:DataType=viewmodels:LibraryManagementViewModel}"
                        CommandParameter="{Binding}"
                        BackgroundColor="{DynamicResource ErrorColor}"
                        TextColor="White"
                        FontSize="14"
                        Padding="16,8"
                        CornerRadius="4"
                        VerticalOptions="Start"
                      />
                    </Grid>
                  </Frame>
                </DataTemplate>
              </CollectionView.ItemTemplate>

              <CollectionView.EmptyView>
                <VerticalStackLayout
                  VerticalOptions="Center"
                  HorizontalOptions="Center"
                  Spacing="10"
                  Padding="40"
                >
                  <Label
                    Text="No libraries found"
                    FontSize="18"
                    HorizontalOptions="Center"
                  />
                  <Label
                    Text="Pull down to refresh"
                    FontSize="14"
                    TextColor="{DynamicResource MutedTextColor}"
                    HorizontalOptions="Center"
                  />
                </VerticalStackLayout>
              </CollectionView.EmptyView>
            </CollectionView>
          </VerticalStackLayout>
        </VerticalStackLayout>
      </ScrollView>

      <!-- Loading Indicator -->
      <ActivityIndicator
        Grid.Row="1"
        IsRunning="{Binding IsLoading}"
        IsVisible="{Binding IsLoading}"
        HeightRequest="50"
        Margin="0,10"
      />
    </Grid>
  </RefreshView>
</ContentPage>
