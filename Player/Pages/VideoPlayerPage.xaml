<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:viewModels="clr-namespace:Player.ViewModels"
  xmlns:models="clr-namespace:Player.Models"
  xmlns:views="clr-namespace:Mpv.Maui.Controls;assembly=Mpv.Maui"
  x:Class="Player.Pages.VideoPlayerPage"
  x:DataType="viewModels:VideoPlayerViewModel"
  Title="{Binding ItemName}"
  NavigationPage.HasNavigationBar="False"
  Shell.NavBarIsVisible="False"
  BackgroundColor="{DynamicResource VideoBackgroundColor}"
>
  <Grid x:Name="RootGrid">
    <!-- Video Player (full screen) -->
    <views:Video
      x:Name="MpvElement"
      Source="{Binding VideoSource}"
      HorizontalOptions="Fill"
      VerticalOptions="Fill"
    />

    <!-- Tap area for showing/hiding controls -->
    <Grid x:Name="TapArea" BackgroundColor="Transparent">
      <Grid.GestureRecognizers>
        <TapGestureRecognizer Tapped="OnVideoTapped" />
      </Grid.GestureRecognizers>
    </Grid>

    <!-- Loading Indicator -->
    <ActivityIndicator
      IsRunning="{Binding IsLoading}"
      IsVisible="{Binding IsLoading}"
      Color="{DynamicResource VideoTextColor}"
      VerticalOptions="Center"
      HorizontalOptions="Center"
      WidthRequest="50"
      HeightRequest="50"
    />

    <!-- Error Message -->
    <Border
      IsVisible="{Binding ErrorMessage, Converter={StaticResource IsStringNotNullOrEmptyConverter}}"
      BackgroundColor="{DynamicResource VideoOverlay80}"
      Padding="20"
      VerticalOptions="Center"
      HorizontalOptions="Center"
    >
      <Border.StrokeShape>
        <RoundRectangle CornerRadius="8" />
      </Border.StrokeShape>
      <VerticalStackLayout Spacing="10">
        <Label
          Text="Playback Error"
          FontSize="18"
          FontAttributes="Bold"
          TextColor="{DynamicResource VideoTextColor}"
          HorizontalOptions="Center"
        />
        <Label
          Text="{Binding ErrorMessage}"
          FontSize="14"
          TextColor="{DynamicResource VideoTextColor}"
          HorizontalOptions="Center"
          MaximumWidthRequest="300"
        />
        <Button
          Text="Close"
          Command="{Binding CloseCommand}"
          BackgroundColor="{DynamicResource PrimaryColor}"
          TextColor="{DynamicResource VideoTextColor}"
          Margin="0,10,0,0"
        />
      </VerticalStackLayout>
    </Border>

    <!-- Controls Overlay Container -->
    <Grid x:Name="ControlsOverlay" VerticalOptions="Fill" InputTransparent="False">
      <!-- Top Bar (Title + Close) -->
      <Border
        x:Name="TopBar"
        VerticalOptions="Start"
        BackgroundColor="{DynamicResource VideoOverlay80}"
        Padding="16,12"
        StrokeThickness="0"
      >
        <Grid ColumnDefinitions="*,Auto">
          <Label
            Text="{Binding ItemName}"
            FontSize="18"
            FontAttributes="Bold"
            TextColor="{DynamicResource VideoTextColor}"
            VerticalOptions="Center"
            LineBreakMode="TailTruncation"
          />
          <Button
            Grid.Column="1"
            Text="X"
            Command="{Binding CloseCommand}"
            BackgroundColor="Transparent"
            TextColor="{DynamicResource VideoTextColor}"
            FontSize="20"
            FontAttributes="Bold"
            WidthRequest="44"
            HeightRequest="44"
            Padding="0"
          />
        </Grid>
      </Border>

      <!-- Center Play/Pause Button -->
      <Border
        x:Name="CenterPlayButton"
        VerticalOptions="Center"
        HorizontalOptions="Center"
        BackgroundColor="{DynamicResource VideoOverlay80}"
        WidthRequest="80"
        HeightRequest="80"
        StrokeThickness="0"
      >
        <Border.StrokeShape>
          <RoundRectangle CornerRadius="40" />
        </Border.StrokeShape>
        <Border.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnPlayPauseTapped" />
        </Border.GestureRecognizers>
        <Label
          x:Name="PlayPauseIcon"
          Text="{Binding IsPlaying, Converter={StaticResource PlayPauseConverter}}"
          FontSize="20"
          TextColor="{DynamicResource VideoTextColor}"
          HorizontalOptions="Center"
          VerticalOptions="Center"
        />
      </Border>

      <!-- Bottom Bar (Slider + Time) -->
      <Border
        x:Name="BottomBar"
        VerticalOptions="End"
        BackgroundColor="{DynamicResource VideoOverlay80}"
        Padding="16,8"
        StrokeThickness="0"
      >
        <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
          <!-- Seek Slider -->
          <views:PositionSlider
            x:Name="PositionSlider"
            Grid.Row="0"
            Duration="{Binding Source={x:Reference MpvElement}, Path=Duration, x:DataType=views:Video}"
            Position="{Binding Source={x:Reference MpvElement}, Path=Position, x:DataType=views:Video}"
            MinimumTrackColor="{DynamicResource PrimaryColor}"
            MaximumTrackColor="{DynamicResource MutedTextColor}"
            ThumbColor="{DynamicResource PrimaryColor}"
            Margin="0"
          />

          <!-- Time Display + Controls -->
          <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto">
            <!-- Current Time -->
            <Label
              Grid.Column="0"
              Text="{Binding CurrentPositionText}"
              TextColor="{DynamicResource VideoTextColor}"
              FontSize="12"
              VerticalOptions="Center"
            />

            <!-- Spacer / Future: additional controls like subtitles, audio tracks -->
            <HorizontalStackLayout Grid.Column="1" HorizontalOptions="Center" Spacing="20">
              <!-- Skip Back 10s -->
              <Border
                BackgroundColor="Transparent"
                WidthRequest="44"
                HeightRequest="44"
                StrokeThickness="0"
              >
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnSkipBackTapped" />
                </Border.GestureRecognizers>
                <Label
                  Text="-10"
                  FontSize="14"
                  FontAttributes="Bold"
                  TextColor="{DynamicResource VideoTextColor}"
                  HorizontalOptions="Center"
                  VerticalOptions="Center"
                />
              </Border>

              <!-- Skip Forward 10s -->
              <Border
                BackgroundColor="Transparent"
                WidthRequest="44"
                HeightRequest="44"
                StrokeThickness="0"
              >
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnSkipForwardTapped" />
                </Border.GestureRecognizers>
                <Label
                  Text="+10"
                  FontSize="14"
                  FontAttributes="Bold"
                  TextColor="{DynamicResource VideoTextColor}"
                  HorizontalOptions="Center"
                  VerticalOptions="Center"
                />
              </Border>

              <!-- Audio Track Button -->
              <Border
                BackgroundColor="Transparent"
                WidthRequest="44"
                HeightRequest="44"
                StrokeThickness="0"
              >
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Command="{Binding ToggleAudioTrackSelectorCommand}" />
                </Border.GestureRecognizers>
                <Label
                  Text="ðŸ”Š"
                  FontSize="20"
                  TextColor="{DynamicResource VideoTextColor}"
                  HorizontalOptions="Center"
                  VerticalOptions="Center"
                />
              </Border>

              <!-- Subtitle Track Button -->
              <Border
                BackgroundColor="Transparent"
                WidthRequest="44"
                HeightRequest="44"
                StrokeThickness="0"
              >
                <Border.GestureRecognizers>
                  <TapGestureRecognizer Command="{Binding ToggleSubtitleTrackSelectorCommand}" />
                </Border.GestureRecognizers>
                <Label
                  Text="CC"
                  FontSize="14"
                  FontAttributes="Bold"
                  TextColor="{DynamicResource VideoTextColor}"
                  HorizontalOptions="Center"
                  VerticalOptions="Center"
                />
              </Border>
            </HorizontalStackLayout>

            <!-- Duration -->
            <Label
              Grid.Column="2"
              Text="{Binding DurationText}"
              TextColor="{DynamicResource VideoTextColor}"
              FontSize="12"
              VerticalOptions="Center"
            />
          </Grid>
        </Grid>
      </Border>
    </Grid>

    <!-- Audio Track Selector Overlay -->
    <Border
      IsVisible="{Binding ShowAudioTrackSelector}"
      VerticalOptions="End"
      BackgroundColor="{DynamicResource VideoOverlay87}"
      Padding="16"
      Margin="0,0,0,100"
      StrokeThickness="0"
      MaximumHeightRequest="400"
      InputTransparent="False"
    >
      <Border.StrokeShape>
        <RoundRectangle CornerRadius="12,12,0,0" />
      </Border.StrokeShape>
      <VerticalStackLayout Spacing="12">
        <Label
          Text="Audio Tracks"
          FontSize="18"
          FontAttributes="Bold"
          TextColor="{DynamicResource VideoTextColor}"
        />
        <ScrollView MaximumHeightRequest="300">
          <CollectionView
            ItemsSource="{Binding AudioTracks}"
            SelectionMode="None"
            x:Name="AudioTracksCollectionView"
          >
            <CollectionView.ItemTemplate>
              <DataTemplate x:DataType="models:TrackInfo">
                <Border Padding="12,8" Margin="0,4" StrokeThickness="0" BackgroundColor="#40FFFFFF">
                  <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                  </Border.StrokeShape>
                  <Border.GestureRecognizers>
                    <TapGestureRecognizer
                      Tapped="OnAudioTrackTapped"
                      CommandParameter="{Binding Id}"
                    />
                  </Border.GestureRecognizers>
                  <Label
                    Text="{Binding DisplayName}"
                    TextColor="{DynamicResource VideoTextColor}"
                    FontSize="14"
                  />
                </Border>
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>
        </ScrollView>
      </VerticalStackLayout>
    </Border>

    <!-- Subtitle Track Selector Overlay -->
    <Border
      IsVisible="{Binding ShowSubtitleTrackSelector}"
      VerticalOptions="End"
      BackgroundColor="{DynamicResource VideoOverlay87}"
      Padding="16"
      Margin="0,0,0,100"
      StrokeThickness="0"
      MaximumHeightRequest="400"
      InputTransparent="False"
    >
      <Border.StrokeShape>
        <RoundRectangle CornerRadius="12,12,0,0" />
      </Border.StrokeShape>
      <VerticalStackLayout Spacing="12">
        <Label
          Text="Subtitle Tracks"
          FontSize="18"
          FontAttributes="Bold"
          TextColor="{DynamicResource VideoTextColor}"
        />
        <ScrollView MaximumHeightRequest="300">
          <VerticalStackLayout Spacing="4">
            <!-- Off Option -->
            <Border BackgroundColor="#40FFFFFF" Padding="12,8" StrokeThickness="0">
              <Border.StrokeShape>
                <RoundRectangle CornerRadius="8" />
              </Border.StrokeShape>
              <Border.GestureRecognizers>
                <TapGestureRecognizer
                  Command="{Binding SelectSubtitleTrackCommand}"
                  CommandParameter="{x:Int32 0}"
                />
              </Border.GestureRecognizers>
              <Label
                Text="Off"
                TextColor="{DynamicResource VideoTextColor}"
                FontSize="14"
                FontAttributes="Bold"
              />
            </Border>

            <!-- Subtitle Tracks -->
            <CollectionView
              ItemsSource="{Binding SubtitleTracks}"
              SelectionMode="None"
              x:Name="SubtitleTracksCollectionView"
            >
              <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:TrackInfo">
                  <Border
                    Padding="12,8"
                    Margin="0,4"
                    StrokeThickness="0"
                    BackgroundColor="#40FFFFFF"
                  >
                    <Border.StrokeShape>
                      <RoundRectangle CornerRadius="8" />
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                      <TapGestureRecognizer
                        Tapped="OnSubtitleTrackTapped"
                        CommandParameter="{Binding Id}"
                      />
                    </Border.GestureRecognizers>
                    <Label
                      Text="{Binding DisplayName}"
                      TextColor="{DynamicResource VideoTextColor}"
                      FontSize="14"
                    />
                  </Border>
                </DataTemplate>
              </CollectionView.ItemTemplate>
            </CollectionView>
          </VerticalStackLayout>
        </ScrollView>
      </VerticalStackLayout>
    </Border>
  </Grid>
</ContentPage>
